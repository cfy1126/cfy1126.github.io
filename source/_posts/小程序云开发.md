---
title: 小程序云开发
date: 2022-07-07 12:36:39
tags: wechat
categories: 技术
---

# 上传数据到云端

```javascript
// 初始化云端数据库
const db = wx.cloud.database()
const products = db.collection('products')

Page({
  data: {},
  onSubmit(event) {
    //添加数据到云端
    products
      .add({
        data: {
          ...event.detail.value,
        },
      })
      .then((res) => {
        console.log(res)
      })
  },
})
```

# 从云端获取数据

```javascript
// 初始化云端数据库
const db = wx.cloud.database()
const products = db.collection('products')

Page({
  data: {
    products: [],
  },
  onLoad() {
    //从云端获取数据
    products.get().then((res) => {
      this.setData({
        products: res.data,
      })
    })
  },
})
```

# 修改删除云数据

```javascript
// 初始化云端数据库
const db = wx.cloud.database()
const products = db.collection('products')

Page({
  data: {
    product: {},
  },
  onLoad(options) {
    // 获取导航传过来的值
    let id = options.id
    products
      .doc(id)
      .get()
      .then((res) => {
        this.setData({
          product: res.data,
        })
      })
  },
  update() {
    //修改云端数据
    products
      .doc(this.data.product._id)
      .update({
        data: {
          price: 399,
        },
      })
      .then((res) => {
        console.log(res)
      })
  },
  del() {
    // 删除云端数据
    products
      .doc(this.data.product._id)
      .remove()
      .then((res) => {
        console.log(res)
      })
  },
})
```

# 云函数

`上传并部署云函数需安装`: npm install --save wx-server-sdk@latest

`添加数据云函数`：

```javascript
// 云函数入口文件
const cloud = require('wx-server-sdk')

cloud.init({
  // 指定环境
  evn: 'invoice-inhand-9g86mm1bfec63201',
})
const db = cloud.database()

// 云函数入口函数
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  //指定云函数功能
  return db.collection('users').add({
    data: {
      name: event.name,
      pwd: event.pwd,
      _openid: wxContext.OPENID,
    },
  })
}
```

`调用云函数`：

```javascript
Page({
  onLoad() {
    // 调用云函数做添加操作
    wx.cloud
      .callFunction({
        name: 'addUser',
        data: {
          name: 'Caofayou',
          pwd: '123456',
        },
      })
      .then((res) => {
        console.log(res)
      })
  },
})
```

# 登录

> 1. 数据获取处理
> 2. 非空校验和格式校验
> 3. 错误提示
> 4. 页面跳转
> 5. 保存用户信息

`处理用户数据`：
![](../img/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%91%E5%BC%80%E5%8F%91/i.png)

`登录成功和失败`：

```javascript
users
  .where({
    name: username,
    pwd: pwd,
  })
  .get()
  .then((res) => {
    // 登录成功
    if (res.data[0] == null) {
      this.setData({
        show: true,
      })
      return
    } else {
    //登录失败
      this.setData({
        show: false,
      })
      app.appUser = res.data[0]
      wx.redirectTo({
        url: '../index/index',
      })
    }
  })
```
